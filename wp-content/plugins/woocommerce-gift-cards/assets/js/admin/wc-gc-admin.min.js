!function(g,w){g(function(){g("select#wc_gc_settings_send_as_gift_status").change(function(){"never"===g(this).val()?g("#wc_gc_allow_multiple_recipients").closest("tr").hide():g("#wc_gc_allow_multiple_recipients").closest("tr").show()}).trigger("change"),g(document.body).on("wc-init-datepickers",function(){g(".date-picker-field, .date-picker").datepicker({dateFormat:"yy-mm-dd",numberOfMonths:1,showButtonPanel:!0})}).trigger("wc-init-datepickers"),g(".woocommerce-gc-giftcards #delete-action").on("click",function(e){if(!w.confirm(wc_gc_admin_params.i18n_wc_delete_card_warning))return e.preventDefault(),!1}),g("#giftcards-table #doaction").on("click",function(e){if("delete"===g("#bulk-action-selector-top").val()&&!w.confirm(wc_gc_admin_params.i18n_wc_bulk_delete_card_warning))return e.preventDefault(),!1}),g("#giftcards-table #doaction2").on("click",function(e){if("delete"===g("#bulk-action-selector-bottom").val()&&!w.confirm(wc_gc_admin_params.i18n_wc_bulk_delete_card_warning))return e.preventDefault(),!1});var e=function(){var e=g(".wc-gc-message-mask");if(!e.length)return!1;var t=!1,i=e.find(".wc-gc-message-mask_placeholder"),o=e.find("#wc_gc_replace_message_cancel").hide(),r=e.find("textarea"),n=g("#edit-gift-card-form");return{hook:function(){e.on("click","#wc_gc_replace_message_action, #wc_gc_replace_message_cancel",function(e){return e.preventDefault(),t?(t=!1,r.hide(),o.hide()):(r.fadeIn("fast"),o.fadeIn("fast"),t=!0),t?i.hide():i.fadeIn("fast"),!1}),n.on("submit",function(e){return!(t&&!w.confirm(wc_gc_admin_params.i18n_wc_edit_message_warning))||(e.preventDefault(),!1)})}}}();function t(r,e){!1!==r&&(r=!0),(e=e||u.find(".show_if_giftcard")).each(function(e){var t=g(this),i=t.find(".show_if_giftcard_simple"),o=t.find(".show_if_giftcard_variable");r?t.show():t.hide(),"simple"===s&&(r?o.hide():o.show(),i.length&&(r?i.show():i.hide())),"variable"===s&&(r?i.hide():i.show(),o.length&&(r?o.show():o.hide()))})}function i(e){t(),r.prop("checked","checked").trigger("change"),n.attr("class","tips"),n.hide(),e&&"undefined"!=e||_.val("none"),l.length&&l.find(".variable_is_virtual").prop("checked","checked").each(function(){var e=g(this);e.trigger("change"),e.parent().hide()})}function o(e){t(!1),n.attr("class",a.join(" ")),r.prop("checked",c?"checked":null).trigger("change"),-1!==g.inArray("show_if_"+s,a)&&n.show(),e&&"undefined"!=e||_.val(d),l.length&&l.find(".variable_is_virtual").each(function(){g(this).parent().show()})}e&&e.hook(),{$order_items_wrapper:g("#woocommerce-order-items"),view:!1,init:function(){this.$order_items_wrapper.length&&this.$order_items_wrapper.on("click","button.add-gift-card",this.add_gift_card.bind(this)).on("click","a.delete-gift-card-item",this.delete_gift_card.bind(this)).on("click","button.configure_gift_card",{action:"configure"},this.clicked_edit_button.bind(this)).on("click","button.edit_gift_card",{action:"edit"},this.clicked_edit_button.bind(this))},reloaded_items:function(){"yes"===wc_gc_admin_params.is_wc_version_gte_3_4?this.$order_items_wrapper.trigger("wc_order_items_reloaded"):(this.core.init_tiptip(),this.core.stupidtable.init())},block:function(e,t){e&&"undefined"!==e||(e=this.$order_items_wrapper);t=g.extend({},{message:null,overlayCSS:{background:"#fff",opacity:.6}},t||{});e.block(t)},unblock:function(e){(e=!e||"undefined"===e?this.$order_items_wrapper:e).unblock()},clicked_edit_button:function(e){var t=g.WCBackboneModal.View.extend({addButton:this.clicked_done_button.bind(this)}),i=g(e.target).closest("tr.item").attr("data-order_item_id");return this.view=new t({target:"wc-modal-edit-gift-card",string:{action:"configure"===e.data.action?wc_gc_admin_params.i18n_configure_order_item:wc_gc_admin_params.i18n_edit_order_item,item_id:i}}),this.populate_form.call(this),!1},clicked_done_button:function(t){this.block(this.view.$el.find(".wc-backbone-modal-content"));var e=g.extend({},this.get_taxable_address(),{action:"wc_gc_edit_order_item_gift_card_in_order",item_id:this.view._string.item_id,fields:this.view.$el.find("input, select, textarea").serialize(),dataType:"json",order_id:woocommerce_admin_meta_boxes.post_id,security:wc_gc_admin_params.edit_gift_card_order_item_nonce});g.post(woocommerce_admin_meta_boxes.ajax_url,e,function(e){e.result&&"success"===e.result?(this.$order_items_wrapper.find(".inside").empty(),this.$order_items_wrapper.find(".inside").append(e.html),this.reloaded_items(),"yes"===wc_gc_admin_params.is_wc_version_gte_3_6&&e.notes_html&&(g("ul.order_notes").empty(),g("ul.order_notes").append(g(e.notes_html).find("li"))),this.unblock(this.view.$el.find(".wc-backbone-modal-content")),this.block(),setTimeout(function(){this.unblock()}.bind(this),250),this.view.closeButton(t)):(w.alert(e.error?e.error.replace(/&quot;/g,'"'):wc_gc_admin_params.i18n_validation_error),this.unblock(this.view.$el.find(".wc-backbone-modal-content")))}.bind(this))},populate_form:function(){this.block(this.view.$el.find(".wc-backbone-modal-content"));var e={action:"wc_gc_configure_order_item_gift_card",item_id:this.view._string.item_id,dataType:"json",order_id:woocommerce_admin_meta_boxes.post_id,security:wc_gc_admin_params.edit_gift_card_order_item_nonce};g.post(woocommerce_admin_meta_boxes.ajax_url,e,function(e){var t,i;e.result&&"success"===e.result?((t=this.view.$el.find("form")).html(e.html),t.wc_gc_datepickers(),t=(e=t.find(".wc-gc-edit-code")).find('input[type="checkbox"]'),i=e.find(".wc-gc-field"),t.is(":checked")||i.show(),t.on("change",function(e){g(this).is(":checked")?i.hide():i.show()}),this.unblock(this.view.$el.find(".wc-backbone-modal-content"))):(w.alert(wc_gc_admin_params.i18n_form_error),this.unblock(this.view.$el.find(".wc-backbone-modal-content")),this.view.$el.find(".modal-close").trigger("click"))}.bind(this))},add_gift_card:function(e){var t,i,o=w.prompt(wc_gc_admin_params.i18n_wc_add_order_item_prompt);return null!==o&&""!==o&&(this.block(),t=g("#customer_user").val(),i=g("#_billing_email").val(),i=g.extend({},this.get_taxable_address(),{action:"wc_gc_add_order_item_gift_card",dataType:"json",order_id:woocommerce_admin_meta_boxes.post_id,security:woocommerce_admin_meta_boxes.order_item_nonce,giftcard:o,user_id:t,user_email:i}),g.ajax({url:woocommerce_admin_meta_boxes.ajax_url,data:i,type:"POST",success:function(e){e.result&&"success"===e.result?(this.$order_items_wrapper.find(".inside").empty(),this.$order_items_wrapper.find(".inside").append(e.html),"yes"===wc_gc_admin_params.is_wc_version_gte_3_6&&e.notes_html&&(g("ul.order_notes").empty(),g("ul.order_notes").append(g(e.notes_html).find("li"))),this.reloaded_items(),this.unblock()):w.alert(e.data.error),this.unblock()}.bind(this)})),e.preventDefault(),!1},delete_gift_card:function(e){var t=g(e.target).closest("tr.item, tr.fee, tr.shipping"),i=t.attr("data-gc_code"),t=t.attr("data-order_item_id");return w.confirm(wc_gc_admin_params.i18n_wc_delete_order_item_warning.replace("%%code%%",i))&&(this.block(),t=g.extend({},this.get_taxable_address(),{order_id:woocommerce_admin_meta_boxes.post_id,order_item_ids:t,action:"wc_gc_remove_order_item_gift_card",security:woocommerce_admin_meta_boxes.order_item_nonce}),"true"===g("button.cancel-action").attr("data-reload")&&(t.items=g("table.woocommerce_order_items :input[name], .wc-order-totals-items :input[name]").serialize()),g.ajax({url:woocommerce_admin_meta_boxes.ajax_url,data:t,type:"POST",success:function(e){e.result&&"success"===e.result?(this.$order_items_wrapper.find(".inside").empty(),this.$order_items_wrapper.find(".inside").append(e.html),"yes"===wc_gc_admin_params.is_wc_version_gte_3_6&&e.notes_html&&(g("ul.order_notes").empty(),g("ul.order_notes").append(g(e.notes_html).find("li"))),this.reloaded_items(),this.unblock()):w.alert(e.data.error),this.unblock()}.bind(this)})),e.preventDefault(),!1},get_taxable_address:function(){var e="",t="",i="",o="";return"shipping"===woocommerce_admin_meta_boxes.tax_based_on&&(e=g("#_shipping_country").val(),t=g("#_shipping_state").val(),i=g("#_shipping_postcode").val(),o=g("#_shipping_city").val()),"billing"!==woocommerce_admin_meta_boxes.tax_based_on&&e||(e=g("#_billing_country").val(),t=g("#_billing_state").val(),i=g("#_billing_postcode").val(),o=g("#_billing_city").val()),{country:e,state:t,postcode:i,city:o}},core:{init_tiptip:function(){g("#tiptip_holder").removeAttr("style"),g("#tiptip_arrow").removeAttr("style"),g(".tips").tipTip({attribute:"data-tip",fadeIn:50,fadeOut:50,delay:200})},stupidtable:{init:function(){g(".woocommerce_order_items").stupidtable(),g(".woocommerce_order_items").on("aftertablesort",this.add_arrows)},add_arrows:function(e,t){var i=g(this).find("th"),o="asc"===t.direction?"&uarr;":"&darr;",t=t.column;i.find(".wc-arrow").remove(),i.eq(t).append('<span class="wc-arrow">'+o+"</span>")}}}}.init();var r,n,c,a,s,_,d,l,m,f,p,u=g("div#woocommerce-product-data");function h(){u.find(".template_default_image_container").each(function(e){var t=g(this),i=t.find("#_gift_card_template_default_use_image"),o=t.find(".gift_card_template_default_custom_image"),r=t.find(".wc_gc_field_select_image"),t=t.find(".wc_gc_field_remove_image");"custom"===i.val()&&o.show(),i.on("change",function(){"custom"===i.val()?o.show():o.hide()}),t.on("click",function(e){var t=g(this),i=t.closest(".wc_gc_select_image"),o=i.find(".wc_gc_field_select_image");e.preventDefault(),o.removeClass("has_image"),t.removeClass("has_image"),i.find("input").val("").trigger("change"),o.find("img").eq(0).attr("src",wc_gc_admin_params.wc_placeholder_img_src)});var n=null;r.on("click",function(e){e.preventDefault();var i=g(this);n||(n=wp.media({title:wc_gc_admin_params.i18n_select_image_frame_title,button:{text:wc_gc_admin_params.i18n_select_image_frame_button},states:[new wp.media.controller.Library({title:wc_gc_admin_params.i18n_select_image_frame_title,filterable:"all"})]})).on("select",function(){var e=n.state().get("selection").first().toJSON(),t=(e.sizes&&e.sizes.thumbnail?e.sizes.thumbnail:e).url;i.addClass("has_image"),i.closest(".wc_gc_select_image").find(".wc_gc_field_remove_image").addClass("has_image"),i.find("input").val(e.id).trigger("change"),i.find("img").eq(0).attr("src",t)}),n.open()})})}u.length&&(r=u.find("#_virtual"),n=r.parent(),c=r.is(":checked"),a=n.attr("class").split(/\s+/),e=u.find("#product-type"),s=e.val(),_=u.find("#_tax_status"),d=_.val(),l=u.find("#variable_product_options"),m=u.find("#_gift_card"),f=m.parent(),p=f.attr("class").split(/\s+/),(m.is(":checked")?i:o)(!0),u.on("woocommerce_variations_loaded woocommerce_variations_added",function(){m.is(":checked")?l.find(".variable_is_virtual").prop("checked","checked").each(function(){var e=g(this);e.trigger("change"),e.parent().hide()}):t(!1),h()}),m.on("change",function(){(g(this).is(":checked")?i:o)()}),e.on("change",function(){s=g(this).val(),-1===g.inArray("show_if_"+s,p)?(f.hide(),t(!1)):m.is(":checked")?t():t(!1)}),h()),b.init()}),g.fn.wc_gc_datepickers=function(){g(this).find(".datepicker").each(function(e){var i=g(this),o=i.parent().find('input[name="wc_gc_giftcard_delivery"]');i.datepicker({beforeShow:function(e,t){g("#ui-datepicker-div").removeClass("wc_gc_datepicker"),g("#ui-datepicker-div").addClass("wc_gc_datepicker")},minDate:"+1D"});var t,r=i.datepicker("getDate");null!==r&&"function"==typeof r.getTime&&(t=new Date,r.setHours(t.getHours(),t.getMinutes()),o.val(r.getTime()/1e3)),i.on("change",function(){var e,t=i.datepicker("getDate");null!==t&&"function"==typeof t.getTime?(e=new Date,t.setHours(e.getHours(),e.getMinutes()),o.val(t.getTime()/1e3)):o.val("")})})};function i(e){this.$form=e,this.is_exporting=!1,this.canceled=!1,this.processStep=this.processStep.bind(this),this.onSubmit=this.onSubmit.bind(this),this.$form.find(".woocommerce-exporter-progress").val(0),e.on("click",".woocommerce-exporter-button",this.onSubmit)}i.prototype.onSubmit=function(e){e.preventDefault();e=new Date,e="wc-gc-giftcards-export-"+e.getDate()+"-"+(e.getMonth()+1)+"-"+e.getFullYear()+"-"+e.getTime()+".csv";this.$form.addClass("woocommerce-exporter__exporting"),this.$form.find(".woocommerce-exporter-button").prop("disabled",!0),this.$form.find(".woocommerce-exporter-progress").val(0),this.processStep(1,[],"",e)},i.prototype.cancel=function(e,t,i,o){this.is_exporting=!1,this.canceled=!0};var b={view:!(i.prototype.processStep=function(e,t,i,o){var r,n=g("#woocommerce-exporter-meta:checked").length?1:0,c=g("#woocommerce-exporter-filtered:checked").length?1:0;c&&(filters={date:!(!(r=function(e){e=e.split("+").join(" ");var t,i={},o=/[?&]?([^=]+)=([^&]*)/g;for(;t=o.exec(e);)i[decodeURIComponent(t[1])]=decodeURIComponent(t[2]);return i}(document.location.search)).m||0==r.m)&&parseInt(r.m,10),customer:!!r._redeemed_filter&&parseInt(r._redeemed_filter,10),search:r.s||!1,status:r.status||!1}),g.ajax({type:"POST",url:wc_gc_admin_params.wc_ajax_url,data:{form:t,action:"woocommerce_gc_do_ajax_giftcards_export",step:e,export_meta:n,export_filters:c,date_filter:!(!c||!filters)&&filters.date,customer_filter:!(!c||!filters)&&filters.customer,status_filter:!(!c||!filters)&&filters.status,search_filter:!(!c||!filters)&&filters.search,filename:o,security:wc_gc_admin_params.export_giftcards_nonce},dataType:"json",success:function(e){if(e.success)if("done"===e.data.step)this.is_exporting=!1,w.location=e.data.url,this.$form.find(".woocommerce-exporter-progress").val(e.data.percentage),setTimeout(function(){this.$form.removeClass("woocommerce-exporter__exporting"),this.$form.find(".woocommerce-exporter-button").prop("disabled",!1),this.$form.find(".woocommerce-exporter-progress").val(0)}.bind(this),2e3);else{if(this.is_exporting=!0,this.$form.find(".woocommerce-exporter-button").prop("disabled",!0),this.$form.find(".woocommerce-exporter-progress").val(e.data.percentage),this.canceled)return this.canceled=!1,this.is_exporting=!1,void setTimeout(function(){this.$form.removeClass("woocommerce-exporter__exporting"),this.$form.find(".woocommerce-exporter-progress").val(0),this.$form.find(".woocommerce-exporter-button").prop("disabled",!1)}.bind(this),2e3);this.processStep(parseInt(e.data.step,10),[],"",o)}}.bind(this)}).fail(function(e){w.console.log(e)})}),export_form:!1,init:function(){g(".woocommerce-gc-giftcards").on("click",".woocommerce-gc-exporter-button",this.open.bind(this))},open:function(e){e.preventDefault();e=g.WCBackboneModal.View.extend({closeButton:this.cancel_export.bind(this)});return this.view=new e({target:"wc-gc-export-giftcards",string:{action:wc_gc_admin_params.i18n_export_modal_title}}),this.populate_form.call(this),!1},cancel_export:function(e){!1===this.export_form||this.export_form.canceled||this.export_form.cancel(),e.preventDefault(),g(document.body).trigger("wc_backbone_modal_before_remove",this.view._target),this.view.undelegateEvents(),g(document).off("focusin"),g(document.body).css({overflow:"auto"}),this.view.remove(),g(document.body).trigger("wc_backbone_modal_removed",this.view._target)},populate_form:function(){this.block(this.view.$el.find(".wc-backbone-modal-content"));var e={action:"wc_gc_export_modal_html",dataType:"json",security:wc_gc_admin_params.modal_export_giftcards_nonce};g.post(wc_gc_admin_params.wc_ajax_url,e,function(e){var t;e.result&&"success"===e.result?((t=this.view.$el.find("form")).html(e.html),t=t.find(".woocommerce-exporter"),this.export_form=new i(t)):console.error(e.result),this.unblock(this.view.$el.find(".wc-backbone-modal-content"))}.bind(this))},block:function(e,t){e&&"undefined"!==e&&(t=g.extend({},{message:null,overlayCSS:{background:"#fff",opacity:.6}},t||{}),e.block(t))},unblock:function(e){e&&"undefined"!==e&&e.unblock()}};g.fn.wc_gc_giftcards_export_form=function(){return new i(this),this}}(jQuery,window);